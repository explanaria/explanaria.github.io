<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<title>three.js webgl - marching cubes</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body {
		  color: #fff;
		  font-family: Monospace;
		  font-size: 13px;
		  text-align: center;

		  background-color: #000;
		  margin: 0px;
		  overflow: hidden;
		}

		#info {
		  color: #ffffff;
		  position: absolute;
		  top: 0px;
		  width: 100%;
		  padding: 5px;
		}

		a {
		  color: gold;
		}

		#webglmessage {
		  font-family: monospace;
		  font-size: 13px;

		  text-align: center;
		  background: rgb(0, 0, 50);
		  color: #fff;
		  padding: 1em;

		  width: 475px;
		  margin: 5em auto 0;

		  display: none;
		}


        #inputbox{
            font-size:2em;
            background-color: #eee;
            color: black;
            margin: auto;
            padding: 0.25em;
            text-align: middle;
        }
        #inputbox input{
            font-size:inherit;
            margin:0.5em; padding:0.25em;background-color:inherit;border:none; border-bottom: 3px solid gray;
        }
        #functionTextRHS{
            width:25%;
            text-align: left;
        }
        #functionTextLHS{
            text-align: right;
        }
	</style>
</head>

<body>

	<div id="container"><canvas width="1360" height="827" style="width: 1360px; height: 827px; position: absolute; top: 0px; left: 0px;"></canvas><div style="position: fixed; top: 0px; left: 0px; cursor: pointer; opacity: 0.9; z-index: 10000;"><canvas width="80" height="48" style="width: 80px; height: 48px; display: block;"></canvas><canvas width="80" height="48" style="width: 80px; height: 48px; display: none;"></canvas></div></div>
	<!-- code from <a href="https://threejs.org/examples/webgl_marchingcubes.html" target="_blank" rel="noopener">threejs.org examples</a> -->
	</div>

	<script src="3DFunctionPlotter_files/lib/three.js"></script>

	<script src="3DFunctionPlotter_files/lib/OrbitControls.js"></script>


	<script src="3DFunctionPlotter_files/lib/DetectWebGL.js"></script>
	<script src="3DFunctionPlotter_files/lib/stats.js"></script>
	<script src="3DFunctionPlotter_files/lib/dat.js"></script>

	<script src="3DFunctionPlotter_files/MarchingCubes.js"></script>
    <script src="3DFunctionPlotter_files/implicitFunctionTextBoxInput.js"></script>
    <script src="3DFunctionPlotter_files/materialsandgui.js"></script>


	<script>
		if ( WEBGL.isWebGLAvailable() === false ) {

			document.body.appendChild( WEBGL.getWebGLErrorMessage() );

		}

		var MARGIN = 0;

		var SCREEN_WIDTH = window.innerWidth;
		var SCREEN_HEIGHT = window.innerHeight - 2 * MARGIN;

		var container, stats;

		var camera, scene, renderer;

		var mesh, texture, geometry, materials, material, current_material;

		var light, pointLight, ambientLight;

		var effect, resolution, numBlobs;

		var effectController;

		var controls;

		var time = 0;
		var clock = new THREE.Clock();

		function init() {

			container = document.getElementById( 'container' );

			// CAMERA

			camera = new THREE.PerspectiveCamera( 45, SCREEN_WIDTH / SCREEN_HEIGHT, 1, 10000 );
			camera.position.set( -500, 500, 1500 );

			// SCENE
			scene = new THREE.Scene();

			// LIGHTS
			light = new THREE.DirectionalLight( 0xffffff );
			light.position.set( 0.5, 0.5, 1 );
			scene.add( light );

			pointLight = new THREE.PointLight( 0xff3300 );
			pointLight.position.set( 0, 0, 20 );
			scene.add( pointLight );

			ambientLight = new THREE.AmbientLight( 0x858585 );
			scene.add( ambientLight );

			// MATERIALS
			materials = generateMaterials();
			current_material = "matte";

			// MARCHING CUBES
			resolution = 28;
			numBlobs = 10;

			effect = new THREE.MarchingCubes( resolution, materials[ current_material ].m, true, true );
			effect.position.set( 0, 0, 0 );
			effect.scale.set( 700, 700, 700 );

			effect.enableUvs = false;
			effect.enableColors = false;

			scene.add( effect );

			// RENDERER

			renderer = new THREE.WebGLRenderer();
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

			renderer.domElement.style.position = "absolute";
			renderer.domElement.style.top = MARGIN + "px";
			renderer.domElement.style.left = "0px";

			container.appendChild( renderer.domElement );
			renderer.gammaInput = true;
			renderer.gammaOutput = true;
            renderer.setClearColor( 0xffffff, 1 );

			// CONTROLS

			controls = new THREE.OrbitControls( camera, renderer.domElement );

			// STATS
			stats = new Stats();
			container.appendChild( stats.dom );

			// GUI
			setupGui();

			// EVENTS
			window.addEventListener( 'resize', onWindowResize, false );
		}
		//

		function onWindowResize( event ) {
			SCREEN_WIDTH = window.innerWidth;
			SCREEN_HEIGHT = window.innerHeight - 2 * MARGIN;
			camera.aspect = SCREEN_WIDTH / SCREEN_HEIGHT;
			camera.updateProjectionMatrix();
			renderer.setSize( SCREEN_WIDTH, SCREEN_HEIGHT );

		}
		function animate() {

			requestAnimationFrame( animate );

			render();
			stats.update();

		}

		function render() {

			var delta = clock.getDelta();

			time += delta * effectController.speed * 0.5;

			// marching cubes

			if ( effectController.resolution !== resolution ) {

				resolution = effectController.resolution;
				effect.init( Math.floor( resolution ) );

			}

        //march the cubes
			effect.reset(); //clear buffer

            let func = (x,y,z, time) => -(Math.sin(x*20) + Math.sin(y*20) + Math.sin(z*20));
            //func = (x,y,z, time) => ( 0.000001 - (x-0.5) * (x-0.5) - (y-0.5)*(y-0.5) - (z-0.5)*(z-0.5) ) + 0.125*(Math.sin(time*3) + 1.1);
            //why does the first function not work but the second does? For that matter, I thought marching cubes rendered f()=0 - why are negative values also showing up?

            effect.addFunction(providedFunc, time);

		//

			// materials
				effect.material.color.setHSL( effectController.hue, effectController.saturation, effectController.lightness );

			// lights

			light.position.set( effectController.lx, effectController.ly, effectController.lz );
			light.position.normalize();

			pointLight.color.setHSL( effectController.lhue, effectController.lsaturation, effectController.llightness );

			// render
				//renderer.clearColor();
				renderer.render( scene, camera );

		}

</script>

<script>

	function queueTextUpdate(){
		window.setTimeout(updateText,1); //hack because I still don't know how to wait
	}
	function setup(){
		queueTextUpdate();

		//provided functions
		for(var name of ['sin','cos','atan','tan','sqrt','exp','abs']){
			window[name] = Math[name];
		}
        init();
        animate();
	}
	window.onload = setup();

</script>
<div id="label" style="width: 100%;pointer-events: all;z-index:999;position:absolute;bottom:10%;">
        <div id="inputbox">
		    <div id="errormessage"></div>
		    <input id="functionTextLHS" type="textarea" value="x+y+z+sin(x)" onkeyup="queueTextUpdate()"></input>=<input id="functionTextRHS" type="textarea" value="0" onkeyup="queueTextUpdate()"></input>
        </div>
</body></html>
